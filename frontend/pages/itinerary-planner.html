<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Itinerary Planner - Velvet Routes</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Inter', sans-serif;
            background: #ffffff;
            color: #1f2937;
        }
        
        .header-bar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem 2rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        
        .main-container {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 2rem;
            padding: 2rem;
            max-width: 1600px;
            margin: 0 auto;
        }
        
        @media (max-width: 1024px) {
            .main-container {
                grid-template-columns: 1fr;
            }
        }
        
        .map-container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            overflow: hidden;
            height: 600px;
            position: relative;
        }
        
        #map {
            width: 100%;
            height: 100%;
        }
        
        .days-panel {
            background: #f9fafb;
            border-radius: 16px;
            padding: 1.5rem;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .day-card {
            background: white;
            border-radius: 12px;
            padding: 1.25rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            border-left: 4px solid #667eea;
            transition: all 0.3s ease;
        }
        
        .day-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }
        
        .day-card.day-1 { border-left-color: #3b82f6; }
        .day-card.day-2 { border-left-color: #10b981; }
        .day-card.day-3 { border-left-color: #f59e0b; }
        .day-card.day-4 { border-left-color: #ef4444; }
        .day-card.day-5 { border-left-color: #8b5cf6; }
        
        .day-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .day-title {
            font-weight: 700;
            font-size: 1.1rem;
            color: #1f2937;
        }
        
        .day-budget {
            background: #f3f4f6;
            padding: 0.25rem 0.75rem;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 600;
            color: #059669;
        }
        
        .place-item {
            background: #f9fafb;
            border-radius: 8px;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: move;
            border: 2px dashed #e5e7eb;
            transition: all 0.2s ease;
        }
        
        .place-item:hover {
            border-color: #667eea;
            background: #f3f4f6;
        }
        
        .place-item.dragging {
            opacity: 0.5;
        }
        
        .place-name {
            font-weight: 500;
            color: #374151;
        }
        
        .place-time {
            font-size: 0.75rem;
            color: #6b7280;
        }
        
        .add-place-btn {
            width: 100%;
            padding: 0.75rem;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-top: 0.5rem;
        }
        
        .add-place-btn:hover {
            background: #5568d3;
            transform: translateY(-1px);
        }
        
        .day-helper {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
            border-radius: 8px;
            padding: 0.75rem;
            margin-top: 0.75rem;
            font-size: 0.875rem;
        }
        
        .day-helper.warning {
            background: #fee2e2;
            border-left-color: #ef4444;
        }
        
        .day-helper.success {
            background: #d1fae5;
            border-left-color: #10b981;
        }
        
        .smart-suggestions {
            background: white;
            border-radius: 12px;
            padding: 1rem;
            margin-top: 1rem;
        }
        
        .suggestion-item {
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            background: #f3f4f6;
            border-radius: 6px;
            font-size: 0.875rem;
        }
        
        .action-buttons {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            display: flex;
            gap: 1rem;
            z-index: 1000;
        }
        
        .action-btn {
            padding: 1rem 1.5rem;
            background: white;
            border: none;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.2);
        }
        
        .action-btn.primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .weather-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        .packing-card {
            background: white;
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
            border: 2px solid #e5e7eb;
        }
        
        .packing-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0;
            border-bottom: 1px solid #f3f4f6;
        }
        
        .packing-item:last-child {
            border-bottom: none;
        }
        
        .carbon-footprint {
            background: #10b981;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 600;
            margin-top: 0.5rem;
            display: inline-block;
        }
        
        .share-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        
        .share-modal.active {
            display: flex;
        }
        
        .share-content {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
        }
        
        .share-link {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }
        
        .share-link input {
            flex: 1;
            padding: 0.75rem;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
        }
        
        .whatsapp-btn {
            background: #25d366;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 1rem;
        }
        
        .empty-day {
            text-align: center;
            padding: 2rem;
            color: #9ca3af;
            font-style: italic;
        }
        
        .travel-time {
            font-size: 0.75rem;
            color: #3b82f6;
            margin-top: 0.25rem;
        }
    </style>
</head>
<body>
    <div class="header-bar">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h1 style="font-size: 1.5rem; font-weight: 700;">üó∫Ô∏è Interactive Itinerary Planner</h1>
            <div style="display: flex; gap: 1rem;">
                <button onclick="window.location.href='planner.html'" style="background: rgba(255,255,255,0.2); padding: 0.5rem 1rem; border-radius: 8px; border: none; color: white; cursor: pointer;">
                    ‚Üê Back
                </button>
            </div>
        </div>
    </div>
    
    <div class="main-container">
        <div>
            <div class="map-container">
                <div id="map"></div>
            </div>
            
            <div class="smart-suggestions" style="margin-top: 1rem;">
                <h3 style="font-weight: 700; margin-bottom: 1rem;">üí° Smart Suggestions</h3>
                <div id="suggestions-list"></div>
            </div>
        </div>
        
        <div class="days-panel">
            <div style="margin-bottom: 1.5rem;">
                <h2 style="font-weight: 700; font-size: 1.25rem; margin-bottom: 1rem;">üìÖ Your Itinerary</h2>
                
                <div class="weather-card" id="weather-card" style="display: none;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-size: 0.875rem; opacity: 0.9;">Weather Forecast</div>
                            <div style="font-size: 1rem; opacity: 0.9; margin-top: 2px;" id="weather-location">--</div>
                            <div style="font-size: 1.5rem; font-weight: 700; margin-top: 4px;" id="weather-temp">--¬∞C</div>
                            <div style="font-size: 0.875rem; opacity: 0.9;" id="weather-desc">--</div>
                        </div>
                        <div style="font-size: 3rem;" id="weather-icon">‚òÄÔ∏è</div>
                    </div>
                </div>
                
                <div class="packing-card" id="packing-card" style="display: none;">
                    <h3 style="font-weight: 700; margin-bottom: 0.75rem;">üß≥ Packing List</h3>
                    <div id="packing-list"></div>
                </div>
            </div>
            
            <div id="days-container"></div>
            
            <button class="add-place-btn" onclick="addNewDay()">+ Add New Day</button>
        </div>
    </div>
    
    <div class="action-buttons">
        <button class="action-btn" onclick="downloadPDF()">üìÑ Download PDF</button>
        <button class="action-btn" onclick="shareTrip()">üîó Share Trip</button>
        <button class="action-btn primary" onclick="showAISuggestions()">ü§ñ AI Suggest</button>
    </div>
    
    <div class="share-modal" id="share-modal">
        <div class="share-content">
            <h3 style="font-weight: 700; margin-bottom: 1rem;">Share Your Trip</h3>
            <div class="share-link">
                <input type="text" id="share-link-input" readonly value="">
                <button onclick="copyShareLink()" style="padding: 0.75rem 1.5rem; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">Copy</button>
            </div>
            <a href="#" id="whatsapp-share" class="whatsapp-btn" target="_blank">
                üì± Share on WhatsApp
            </a>
            <button onclick="closeShareModal()" style="margin-top: 1rem; padding: 0.5rem 1rem; background: #f3f4f6; border: none; border-radius: 8px; cursor: pointer;">Close</button>
        </div>
    </div>
    
    <script src="../assets/js/Script.js"></script>
    <script>
        // Global variables
        let map;
        let markers = [];
        let itineraryDays = [];
        let currentDestination = null;
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadTravelData();
            initializeMap();
            
            // Check for shared trip in URL
            const urlParams = new URLSearchParams(window.location.search);
            const shareId = urlParams.get('share');
            const tripParam = urlParams.get('trip');
            
            if (shareId) {
                loadSharedTrip(shareId);
            } else if (tripParam) {
                try {
                    const tripData = JSON.parse(atob(tripParam));
                    itineraryDays = tripData;
                    renderDays();
                } catch (error) {
                    console.error('Error parsing trip data:', error);
                    initializeDays();
                }
            } else {
                initializeDays();
            }
            
            loadWeatherAndPacking();
        });
        
        // Load shared trip from API
        async function loadSharedTrip(shareId) {
            try {
                const response = await fetch(`http://localhost:3000/api/trips/share/${shareId}`);
                const data = await response.json();
                if (data.success && data.tripData) {
                    itineraryDays = data.tripData.days || [];
                    if (data.tripData.destination) {
                        travelData.destination = data.tripData.destination;
                        geocodeDestination(data.tripData.destination);
                    }
                    renderDays();
                    showNotification('Shared trip loaded!', 'success');
                }
            } catch (error) {
                console.error('Error loading shared trip:', error);
                showNotification('Failed to load shared trip', 'error');
                initializeDays();
            }
        }
        
        // Initialize map
        function initializeMap() {
            // Default center (can be updated based on destination)
            map = L.map('map').setView([20.5937, 78.9629], 5);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);
            
            // Click anywhere on the map to update weather for that point
            map.on('click', async (e) => {
                const { lat, lng } = e.latlng;
                await updateWeatherForLocation(lat, lng);
            });

            // Get destination from travel data
            if (travelData.destination) {
                geocodeDestination(travelData.destination);
            }
        }
        
        // Geocode destination and center map
        async function geocodeDestination(destination) {
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(destination)}`);
                const data = await response.json();
                if (data.length > 0) {
                    const lat = parseFloat(data[0].lat);
                    const lon = parseFloat(data[0].lon);
                    map.setView([lat, lon], 12);
                    currentDestination = { name: destination, lat, lon };
                }
            } catch (error) {
                console.error('Geocoding error:', error);
            }
        }
        
        // Initialize days based on trip duration
        function initializeDays() {
            const duration = travelData.duration || 3;
            itineraryDays = [];
            
            for (let i = 1; i <= duration; i++) {
                itineraryDays.push({
                    day: i,
                    places: [],
                    budget: 0,
                    carbonFootprint: 0
                });
            }
            
            renderDays();
        }
        
        // Render day cards
        function renderDays() {
            const container = document.getElementById('days-container');
            container.innerHTML = '';
            
            itineraryDays.forEach(dayData => {
                const dayCard = createDayCard(dayData);
                container.appendChild(dayCard);
            });
            
            updateMapMarkers();
            updateSmartSuggestions();
        }
        
        // Create day card
        function createDayCard(dayData) {
            const card = document.createElement('div');
            card.className = `day-card day-${dayData.day}`;
            card.dataset.day = dayData.day;
            
            const placesHTML = dayData.places.length > 0 
                ? dayData.places.map((place, idx) => `
                    <div class="place-item" draggable="true" data-day="${dayData.day}" data-index="${idx}">
                        <div>
                            <div class="place-name">${place.name}</div>
                            <div class="place-time">${place.time || 'Time not set'}</div>
                            ${idx > 0 ? `<div class="travel-time">üöó ${calculateTravelTime(dayData.places[idx-1], place)} min</div>` : ''}
                        </div>
                        <button onclick="removePlace(${dayData.day}, ${idx})" style="background: #ef4444; color: white; border: none; border-radius: 4px; padding: 0.25rem 0.5rem; cursor: pointer; font-size: 0.75rem;">√ó</button>
                    </div>
                `).join('')
                : '<div class="empty-day">No places added yet</div>';
            
            const helperHTML = getDayHelperHTML(dayData);
            
            card.innerHTML = `
                <div class="day-header">
                    <div class="day-title">Day ${dayData.day}</div>
                    <div class="day-budget">‚Çπ${dayData.budget.toLocaleString()}</div>
                </div>
                <div class="places-list">
                    ${placesHTML}
                </div>
                ${helperHTML}
                <button class="add-place-btn" onclick="showAddPlaceModal(${dayData.day})">+ Add Place</button>
            `;
            
            // Add drag and drop
            card.querySelectorAll('.place-item').forEach(item => {
                item.addEventListener('dragstart', handleDragStart);
                item.addEventListener('dragover', handleDragOver);
                item.addEventListener('drop', handleDrop);
                item.addEventListener('dragend', handleDragEnd);
            });
            
            return card;
        }
        
        // Calculate travel time between places (simplified)
        function calculateTravelTime(place1, place2) {
            // Simple estimation: 15-30 minutes average
            return Math.floor(Math.random() * 15) + 15;
        }
        
        // Get day helper HTML
        function getDayHelperHTML(dayData) {
            const places = dayData.places;
            let helperClass = 'success';
            let message = 'Day looks good!';
            
            if (places.length === 0) {
                helperClass = 'warning';
                message = '‚ö†Ô∏è This day is empty. Add some places to make the most of your trip!';
            } else if (places.length > 6) {
                helperClass = 'warning';
                message = '‚ö†Ô∏è This day is too full! Consider moving some places to another day.';
            } else {
                // Check for time conflicts
                const conflicts = checkTimeConflicts(places);
                if (conflicts.length > 0) {
                    helperClass = 'warning';
                    message = `‚ö†Ô∏è Time conflict: ${conflicts[0]}`;
                }
            }
            
            const carbonHTML = dayData.carbonFootprint > 0 
                ? `<div class="carbon-footprint">üå± CO‚ÇÇ: ${dayData.carbonFootprint.toFixed(2)} kg</div>`
                : '';
            
            return `
                <div class="day-helper ${helperClass}">
                    ${message}
                    ${carbonHTML}
                </div>
            `;
        }
        
        // Check for time conflicts
        function checkTimeConflicts(places) {
            const conflicts = [];
            for (let i = 0; i < places.length - 1; i++) {
                if (places[i].time && places[i+1].time) {
                    const time1 = parseTime(places[i].time);
                    const time2 = parseTime(places[i+1].time);
                    if (time1 >= time2) {
                        conflicts.push(`${places[i].name} and ${places[i+1].name} have overlapping times`);
                    }
                }
            }
            return conflicts;
        }
        
        // Parse time string (simplified)
        function parseTime(timeStr) {
            const match = timeStr.match(/(\d+):(\d+)/);
            if (match) {
                return parseInt(match[1]) * 60 + parseInt(match[2]);
            }
            return 0;
        }
        
        // Show add place modal
        function showAddPlaceModal(day) {
            const placeName = prompt('Enter place name:');
            if (!placeName) return;
            
            const time = prompt('Enter time (e.g., 10:00 AM):') || '';
            const lat = currentDestination?.lat || (20.5937 + Math.random() * 0.1);
            const lon = currentDestination?.lon || (78.9629 + Math.random() * 0.1);
            
            const place = {
                name: placeName,
                time: time,
                lat: lat,
                lon: lon,
                budget: Math.floor(Math.random() * 500) + 500,
                carbonFootprint: Math.random() * 2 + 0.5
            };
            
            addPlaceToDay(day, place);
        }
        
        // Add place to day
        function addPlaceToDay(day, place) {
            const dayData = itineraryDays.find(d => d.day === day);
            if (dayData) {
                dayData.places.push(place);
                dayData.budget += place.budget;
                dayData.carbonFootprint += place.carbonFootprint;
                renderDays();
            }
        }
        
        // Remove place
        function removePlace(day, index) {
            const dayData = itineraryDays.find(d => d.day === day);
            if (dayData && dayData.places[index]) {
                const place = dayData.places[index];
                dayData.budget -= place.budget;
                dayData.carbonFootprint -= place.carbonFootprint;
                dayData.places.splice(index, 1);
                renderDays();
            }
        }
        
        // Drag and drop handlers
        let draggedElement = null;
        
        function handleDragStart(e) {
            draggedElement = this;
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }
        
        function handleDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }
            e.dataTransfer.dropEffect = 'move';
            return false;
        }
        
        function handleDrop(e) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }
            
            if (draggedElement !== this) {
                const sourceDay = parseInt(draggedElement.dataset.day);
                const sourceIndex = parseInt(draggedElement.dataset.index);
                const targetDay = parseInt(this.dataset.day);
                const targetIndex = parseInt(this.dataset.index);
                
                // Move place
                const sourceDayData = itineraryDays.find(d => d.day === sourceDay);
                const targetDayData = itineraryDays.find(d => d.day === targetDay);
                
                if (sourceDayData && targetDayData) {
                    const place = sourceDayData.places.splice(sourceIndex, 1)[0];
                    targetDayData.places.splice(targetIndex, 0, place);
                    
                    // Update budgets
                    sourceDayData.budget -= place.budget;
                    sourceDayData.carbonFootprint -= place.carbonFootprint;
                    targetDayData.budget += place.budget;
                    targetDayData.carbonFootprint += place.carbonFootprint;
                    
                    renderDays();
                }
            }
            
            return false;
        }
        
        function handleDragEnd(e) {
            this.classList.remove('dragging');
            draggedElement = null;
        }
        
        // Update map markers
        function updateMapMarkers() {
            // Clear existing markers
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];
            
            // Add markers for each place
            itineraryDays.forEach((dayData, dayIndex) => {
                const colors = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6'];
                const color = colors[dayIndex % colors.length];
                
                dayData.places.forEach(place => {
                    const marker = L.marker([place.lat, place.lon], {
                        icon: L.divIcon({
                            className: 'custom-marker',
                            html: `<div style="background: ${color}; width: 20px; height: 20px; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);"></div>`,
                            iconSize: [20, 20]
                        })
                    }).addTo(map);
                    
                    marker.bindPopup(`<b>Day ${dayData.day}</b><br>${place.name}<br>${place.time || 'Time not set'}`);
                    // Clicking a marker updates weather for that exact place
                    marker.on('click', () => {
                        updateWeatherForLocation(place.lat, place.lon, place.name);
                    });
                    markers.push(marker);
                });
            });
        }
        
        // Update smart suggestions
        function updateSmartSuggestions() {
            const suggestionsList = document.getElementById('suggestions-list');
            const suggestions = [];
            
            itineraryDays.forEach(dayData => {
                if (dayData.places.length === 0) {
                    suggestions.push(`Day ${dayData.day} is empty. Add some places to make it memorable!`);
                } else if (dayData.places.length > 6) {
                    suggestions.push(`Day ${dayData.day} is too full. Consider moving some places to another day.`);
                }
                
                // Check for early starts
                const earlyPlaces = dayData.places.filter(p => p.time && parseTime(p.time) < 480); // Before 8 AM
                if (earlyPlaces.length > 0 && dayData.places.length > 3) {
                    suggestions.push(`Day ${dayData.day} starts early. Make sure to get enough rest!`);
                }
            });
            
            if (suggestions.length === 0) {
                suggestions.push('Your itinerary looks balanced! üéâ');
            }
            
            suggestionsList.innerHTML = suggestions.map(s => 
                `<div class="suggestion-item">üí° ${s}</div>`
            ).join('');
        }
        
        // Load weather and packing
        async function loadWeatherAndPacking() {
            try {
                // If we have a destination, center and fetch weather there
                if (travelData.destination) {
                    const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(travelData.destination)}`);
                    const data = await response.json();
                    if (data.length > 0) {
                        const lat = parseFloat(data[0].lat);
                        const lon = parseFloat(data[0].lon);
                        await updateWeatherForLocation(lat, lon, travelData.destination);
                    }
                }
            } catch (error) {
                console.error('Error loading weather:', error);
            }
        }

        // Fetch live weather for a given lat/lon using Open-Meteo (no API key required)
        async function updateWeatherForLocation(lat, lon, label) {
            try {
                // Reverse geocode to get a readable name if not provided
                let locationLabel = label || `${lat.toFixed(3)}, ${lon.toFixed(3)}`;
                if (!label) {
                    try {
                        const rev = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`);
                        const revData = await rev.json();
                        if (revData && revData.address) {
                            const city = revData.address.city || revData.address.town || revData.address.village || '';
                            const country = revData.address.country || '';
                            locationLabel = [city, country].filter(Boolean).join(', ') || locationLabel;
                        }
                    } catch (_) {}
                }

                const resp = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true`);
                const json = await resp.json();
                if (json && json.current_weather) {
                    const temp = Math.round(json.current_weather.temperature);
                    const code = json.current_weather.weathercode;
                    const desc = getWeatherDescription(code);
                    const icon = getWeatherIcon(code);

                    document.getElementById('weather-location').textContent = locationLabel;
                    document.getElementById('weather-temp').textContent = `${temp}¬∞C`;
                    document.getElementById('weather-desc').textContent = desc;
                    document.getElementById('weather-icon').textContent = icon;
                    document.getElementById('weather-card').style.display = 'block';

                    // Update packing list based on temperature/conditions
                    const packingList = generatePackingList({ temp, desc });
                    document.getElementById('packing-list').innerHTML = packingList;
                    document.getElementById('packing-card').style.display = 'block';
                }
            } catch (error) {
                console.error('Weather fetch error:', error);
            }
        }

        // Map Open-Meteo weather codes to human text
        function getWeatherDescription(code) {
            const map = {
                0: 'Clear sky',
                1: 'Mainly clear', 2: 'Partly cloudy', 3: 'Overcast',
                45: 'Fog', 48: 'Depositing rime fog',
                51: 'Light drizzle', 53: 'Moderate drizzle', 55: 'Dense drizzle',
                56: 'Light freezing drizzle', 57: 'Dense freezing drizzle',
                61: 'Slight rain', 63: 'Moderate rain', 65: 'Heavy rain',
                66: 'Light freezing rain', 67: 'Heavy freezing rain',
                71: 'Slight snow fall', 73: 'Moderate snow fall', 75: 'Heavy snow fall',
                77: 'Snow grains',
                80: 'Slight rain showers', 81: 'Moderate rain showers', 82: 'Violent rain showers',
                85: 'Slight snow showers', 86: 'Heavy snow showers',
                95: 'Thunderstorm', 96: 'Thunderstorm with slight hail', 99: 'Thunderstorm with heavy hail'
            };
            return map[code] || 'Unknown conditions';
        }

        function getWeatherIcon(code) {
            if (code === 0) return '‚òÄÔ∏è';
            if ([1,2].includes(code)) return 'üå§Ô∏è';
            if (code === 3) return '‚òÅÔ∏è';
            if ([45,48].includes(code)) return 'üå´Ô∏è';
            if ([51,53,55,61,63,65,80,81,82].includes(code)) return 'üåßÔ∏è';
            if ([66,67].includes(code)) return 'üåßÔ∏è';
            if ([71,73,75,77,85,86].includes(code)) return 'üå®Ô∏è';
            if ([95,96,99].includes(code)) return '‚õàÔ∏è';
            return 'üå•Ô∏è';
        }
        
        // Generate packing list
        function generatePackingList(weather) {
            const baseItems = [
                'Passport & ID',
                'Travel documents',
                'Cash & cards',
                'Phone charger',
                'First aid kit'
            ];
            
            const weatherItems = weather.temp > 25 
                ? ['Light clothes', 'Sunglasses', 'Sun hat', 'Sunscreen', 'Swimwear']
                : ['Warm clothes', 'Jacket', 'Umbrella', 'Scarf'];
            
            return [...baseItems, ...weatherItems].map(item => 
                `<div class="packing-item">‚òëÔ∏è ${item}</div>`
            ).join('');
        }
        
        // Add new day
        function addNewDay() {
            const newDay = {
                day: itineraryDays.length + 1,
                places: [],
                budget: 0,
                carbonFootprint: 0
            };
            itineraryDays.push(newDay);
            renderDays();
        }
        
        // Download PDF
        function downloadPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.setFontSize(20);
            doc.text('Travel Itinerary', 20, 20);
            
            let y = 40;
            itineraryDays.forEach(dayData => {
                doc.setFontSize(16);
                doc.text(`Day ${dayData.day}`, 20, y);
                y += 10;
                
                doc.setFontSize(12);
                dayData.places.forEach(place => {
                    doc.text(`‚Ä¢ ${place.name} (${place.time || 'Time TBD'})`, 20, y);
                    y += 7;
                });
                
                doc.text(`Budget: ‚Çπ${dayData.budget.toLocaleString()}`, 20, y);
                y += 10;
            });
            
            doc.save('velvet-routes-itinerary.pdf');
            showNotification('PDF downloaded successfully!', 'success');
        }
        
        // Share trip
        async function shareTrip() {
            try {
                const token = localStorage.getItem('velvetRoutesToken');
                if (!token) {
                    // Fallback to local sharing
                    const shareLink = `${window.location.origin}${window.location.pathname}?trip=${btoa(JSON.stringify(itineraryDays))}`;
                    document.getElementById('share-link-input').value = shareLink;
                    document.getElementById('share-modal').classList.add('active');
                    
                    const whatsappText = encodeURIComponent(`Check out my travel itinerary on Velvet Routes: ${shareLink}`);
                    document.getElementById('whatsapp-share').href = `https://wa.me/?text=${whatsappText}`;
                    return;
                }
                
                // Use API for persistent sharing
                const response = await fetch('http://localhost:3000/api/trips/share', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        tripData: {
                            days: itineraryDays,
                            destination: travelData.destination,
                            dates: {
                                departure: travelData.departureDate,
                                return: travelData.returnDate
                            }
                        }
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    document.getElementById('share-link-input').value = data.shareLink;
                    document.getElementById('share-modal').classList.add('active');
                    document.getElementById('share-modal').dataset.shareId = data.shareId;
                    
                    // Load comments
                    loadComments(data.shareId);
                    
                    // WhatsApp share
                    const whatsappText = encodeURIComponent(`Check out my travel itinerary on Velvet Routes: ${data.shareLink}`);
                    document.getElementById('whatsapp-share').href = `https://wa.me/?text=${whatsappText}`;
                } else {
                    throw new Error('Failed to create share link');
                }
            } catch (error) {
                console.error('Share error:', error);
                showNotification('Failed to create share link. Using local sharing.', 'warning');
                // Fallback to local sharing
                const shareLink = `${window.location.origin}${window.location.pathname}?trip=${btoa(JSON.stringify(itineraryDays))}`;
                document.getElementById('share-link-input').value = shareLink;
                document.getElementById('share-modal').classList.add('active');
            }
        }
        
        // Load comments for shared trip
        async function loadComments(shareId) {
            try {
                const response = await fetch(`http://localhost:3000/api/trips/share/${shareId}/comments`);
                const data = await response.json();
                if (data.success && data.comments) {
                    // Display comments in modal
                    const commentsHTML = data.comments.map(comment => `
                        <div style="padding: 0.5rem; background: #f3f4f6; border-radius: 8px; margin-top: 0.5rem;">
                            <div style="font-weight: 600;">${comment.user_name}</div>
                            <div style="font-size: 0.875rem; color: #6b7280;">${comment.comment}</div>
                            <div style="font-size: 0.75rem; color: #9ca3af; margin-top: 0.25rem;">${new Date(comment.created_at).toLocaleString()}</div>
                        </div>
                    `).join('');
                    
                    const commentsSection = document.getElementById('comments-section') || document.createElement('div');
                    commentsSection.id = 'comments-section';
                    commentsSection.innerHTML = `
                        <h4 style="font-weight: 700; margin-top: 1rem; margin-bottom: 0.5rem;">Comments</h4>
                        ${commentsHTML}
                        <div style="margin-top: 1rem;">
                            <textarea id="new-comment" placeholder="Add a comment..." style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; margin-bottom: 0.5rem;"></textarea>
                            <button onclick="addComment('${shareId}')" style="padding: 0.5rem 1rem; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">Post Comment</button>
                        </div>
                    `;
                    
                    const shareContent = document.querySelector('.share-content');
                    if (!shareContent.querySelector('#comments-section')) {
                        shareContent.appendChild(commentsSection);
                    }
                }
            } catch (error) {
                console.error('Error loading comments:', error);
            }
        }
        
        // Add comment
        async function addComment(shareId) {
            try {
                const commentText = document.getElementById('new-comment').value;
                if (!commentText.trim()) return;
                
                const token = localStorage.getItem('velvetRoutesToken');
                if (!token) {
                    showNotification('Please login to add comments', 'warning');
                    return;
                }
                
                const response = await fetch(`http://localhost:3000/api/trips/share/${shareId}/comments`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ comment: commentText })
                });
                
                const data = await response.json();
                if (data.success) {
                    document.getElementById('new-comment').value = '';
                    loadComments(shareId);
                    showNotification('Comment added!', 'success');
                }
            } catch (error) {
                console.error('Error adding comment:', error);
                showNotification('Failed to add comment', 'error');
            }
        }
        
        // Make addComment globally available
        window.addComment = addComment;
        
        // Copy share link
        function copyShareLink() {
            const input = document.getElementById('share-link-input');
            input.select();
            document.execCommand('copy');
            showNotification('Link copied to clipboard!', 'success');
        }
        
        // Close share modal
        function closeShareModal() {
            document.getElementById('share-modal').classList.remove('active');
        }
        
        // AI Suggestions
        function showAISuggestions() {
            const suggestions = [
                'Visit local markets for authentic experiences',
                'Schedule outdoor activities in the morning',
                'Leave buffer time between activities',
                'Book popular attractions in advance',
                'Try local cuisine at recommended restaurants'
            ];
            
            const randomSuggestion = suggestions[Math.floor(Math.random() * suggestions.length)];
            showNotification(`AI Suggestion: ${randomSuggestion}`, 'info');
        }
    </script>
</body>
</html>

